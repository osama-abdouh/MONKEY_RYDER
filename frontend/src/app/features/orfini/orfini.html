<div class="ordini-container">
  <h2>I miei ordini</h2>

  <div *ngIf="isLoading" class="info">Caricamento in corso...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!isLoading && orders.length === 0" class="info">Nessun ordine trovato.</div>

  <table *ngIf="orders.length > 0" class="orders-table">
    <thead>
      <tr>
        <th>ID ordine</th>
        <th>Data</th>
        <th>Prezzo</th>
        <th>Stato</th>
        <th>Pagamento</th>
      </tr>
    </thead>
    <tbody>
  <tr *ngFor="let o of orders; trackBy: trackByOrderId" class="clickable-row" (click)="openOrderDetails(o.id_ordine)">
        <td>{{ o.id_ordine }}</td>
        <td>{{ o.datas | date:'short' }}</td>
        <td>{{ formatCurrency(o.prezzo) }}</td>
        <td>{{ o.stato || '-' }}</td>
        <td>
          <div *ngIf="o.payment_status">{{ o.payment_status }}</div>
          <div *ngIf="o.payment_provider">{{ o.payment_provider }}</div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Modal dettagli ordine -->
  <div class="modal-backdrop" *ngIf="selectedOrderDetails">
    <div class="modal">
      <br>
      <hr>
      <hr>
      <br>
      <button class="close" (click)="closeDetails()">×</button>
      <h3>Dettagli Ordine #{{ selectedOrderDetails.order.id_ordine }}</h3> <br>
      <div *ngIf="detailsLoading" class="info">Caricamento dettagli...</div>
      <div *ngIf="detailsError" class="error">{{ detailsError }}</div>
  <div *ngIf="!detailsLoading && selectedOrderDetails" class="modal-body">
        <div class="order-meta">
          <p><strong>Data:</strong> {{ selectedOrderDetails.order.datas | date:'full' }}</p>
          <p><strong>Prezzo:</strong> {{ formatCurrency(selectedOrderDetails.order.prezzo) }}</p>
          <p><strong>Stato:</strong> {{ selectedOrderDetails.order.stato }}</p>
          <p *ngIf="selectedOrderDetails.order.delivery_address"><strong>Indirizzo:</strong> {{ selectedOrderDetails.order.delivery_address }}, {{ selectedOrderDetails.order.delivery_city }} {{ selectedOrderDetails.order.delivery_postal_code }}</p>
        </div>

          <!-- show cancel button only when order is pending -->
          <div style="text-align:left; margin:8px 0;">
            <button *ngIf="isOrderPending()" class="btn-cancel" (click)="cancelOrder()">Annulla ordine</button>
          </div>
        <br>
        <hr>
        <hr>
        <br>

        <h3>Prodotti</h3>
        <div *ngIf="selectedOrderDetails.items && selectedOrderDetails.items.length > 0">
          <ul class="items-list">
            <li *ngFor="let it of selectedOrderDetails.items; trackBy: trackByOrderItemId">
              <div class="item-row">
                <img [src]="getOrderItemImageUrl(it)" alt="" class="item-img" />
                <div class="item-info">
                  <div class="item-name">{{ it.product_name || it.name || (it.product_id ? ('Prodotto #' + it.product_id) : 'Prodotto') }}</div>
                  <div class="item-qty">Quantità: {{ it.quantity || it.qty || it.qta || '-' }}</div>
                  <div class="item-price">Prezzo unitario: {{ formatCurrency(it.unit_price || it.product_price || it.price) }}</div> 
                </div>
                
              </div>
            </li>
            <hr>
          </ul>
          <hr>
        </div>
        <div *ngIf="!selectedOrderDetails.items || selectedOrderDetails.items.length === 0" class="info">Nessun dettaglio prodotti disponibile per questo ordine.</div>
      </div>
    </div>
  </div>
</div>

