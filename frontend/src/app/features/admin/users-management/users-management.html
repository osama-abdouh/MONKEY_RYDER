<div class="user-page">
  <div class="header">
  </div>
  <div class="options-bar">
    <input type="text" placeholder="Cerca utenti..." [(ngModel)]="searchTerm" (ngModelChange)="filterUsers()"/>
    <button (click)="toggleCreate($event)">Crea Nuovo Utente</button>
  </div>
  <div class="users-table">
    @if(loading){
      <div>Caricamento utenti...</div>
    } @else if(error){
      <div class="error">{{ error }}</div>
    } @else if(filteredUsers.length === 0){
      <div>Nessun utente trovato.</div>
    } @else {
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Data di nascita</th>
            <th>Telefono</th>
            <th>Ruolo</th>
            <th>Stato</th>
            <th>Data di creazione</th>
            <th>Ultimo accesso</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          @for(user of displayedUsers; track user.user_id) {
            <tr>
              <td>{{ user.first_name + ' ' + user.last_name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.birth_date | date: 'dd/MM/yyyy' }}</td>
              <td>{{ user.phone_number }}</td>
              <td>{{ user.role }}</td>
              <td>{{ user.account_status }}</td>
              <td>{{ user.created_at | date: 'dd/MM/yyyy'}}</td>
              <td>{{ user.last_login | date: 'dd/MM/yyyy'}}</td>
              <td class="actions-cell">
                <button (click)="toggleDetails($event, user)">Dettagli</button>
                <button (click)="deleteUser(user)">Elimina</button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    }
    <!-- Paginazione -->
    @if(totalPages > 1){
      <div class="pagination">
        <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
        @for(p of pages; track p) {
          <button (click)="goToPage(p)" [class.active]="currentPage === p">{{ p }}</button>
        }
        <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">Next</button>
      </div>
    }
  </div>
  @if(showCreate){
  <div class="popup-overlay" aria-modal="true" role="dialog">
    <div class="popup-content">
      <header class="popup-header">
        <h3>Nuovo utente</h3>
      </header>
      <div class="popup-body">
        <div class="form-row">
          <label>Nome</label>
          <input type="text" [(ngModel)]="newUser.first_name" placeholder="Mario" />
        </div>
        <div class="form-row">
          <label>Cognome</label>
          <input type="text" [(ngModel)]="newUser.last_name" placeholder="Rossi" />
        </div>
        <div class="form-row">
          <label>Email</label>
          <input type="email" [(ngModel)]="newUser.email" placeholder="mario.rossi@example.com" />
        </div>
        <div class="form-row">
          <label>Password</label>
          <input type="password" [(ngModel)]="newUser.password" placeholder="••••••••" />
        </div>
        <div class="form-row">
          <label>Data di nascita</label>
          <input type="date" [(ngModel)]="newUser.birth_date" />
        </div>
        <div class="form-row">
          <label>Telefono</label>
          <input type="tel" [(ngModel)]="newUser.phone_number" placeholder="3331234567" />
        </div>
        <div class="form-row">
          <label>Ruolo</label>
          <select [(ngModel)]="newUser.role">
            <option value="customer">customer</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <div class="form-row">
          <label>Stato account</label>
          <select [(ngModel)]="newUser.account_status">
            <option value="active">active</option>
            <option value="suspended">suspended</option>
          </select>
        </div>
      </div>
      @if(error){
        <div class="error-muted" >{{ error }}</div>
      }
      <footer class="popup-footer">
        <button class="annulla-button" (click)="toggleCreate($event)">Annulla</button>
        <button class="create-button" (click)="createUser()">Crea</button>
      </footer>
    </div>
  </div>
}
  @if(showDetails && selectedUser){
  <div class="popup-overlay" aria-modal="true" role="dialog">
    <div class="popup-content">
      <header class="popup-header">
        <h3>Dettagli utente</h3>
      </header>
      <div class="popup-body-details">
        <div class="user-details">
          <div class="detail-row">
            <label>Nome:</label>
            @if(!isEditing){
              <p>{{ selectedUser.first_name }}</p>
            } @else {
              <input type="text" [(ngModel)]="editedUser!.first_name" class="form-control" placeholder="Nome" />
            }
          </div>
          <div class="detail-row">
            <label>Cognome:</label>
            @if(!isEditing){
              <p>{{ selectedUser.last_name }}</p>
            } @else {
              <input type="text" [(ngModel)]="editedUser!.last_name" class="form-control" placeholder="Cognome" />
            }
          </div>
          <div class="detail-row">
            <label>Email:</label>
            @if(!isEditing){
              <p>{{ selectedUser.email }}</p>
            } @else {
              <input type="email" [(ngModel)]="editedUser!.email" class="form-control" placeholder="Email" />
            }
          </div>

          <div class="detail-row">
            <label>Data di nascita:</label>
            @if(!isEditing){
              <p>{{ selectedUser.birth_date | date: 'dd/MM/yyyy' }}</p>
            } @else {
              <input type="date" [(ngModel)]="editedUser!.birth_date" class="form-control" />
            }
          </div>

          <div class="detail-row">
            <label>Telefono:</label>
            @if(!isEditing){
              <p>{{ selectedUser.phone_number }}</p>
            } @else {
              <input type="tel" [(ngModel)]="editedUser!.phone_number" class="form-control" placeholder="Telefono" />
            }
          </div>
          <div class="detail-row">
            <label>Ruolo:</label>
            @if(!isEditing){
              <p>{{ selectedUser.role }}</p>
            } @else {
              <select [(ngModel)]="editedUser!.role" class="form-control">
                <option value="customer">customer</option>
                <option value="admin">admin</option>
              </select>
            }
          </div>
          <div class="detail-row">
            <label>Stato account:</label>
            @if(!isEditing){
              <p>{{ selectedUser.account_status }}</p>
            } @else {
              <select [(ngModel)]="editedUser!.account_status" class="form-control">
                <option value="active">active</option>
                <option value="suspended">suspended</option>
              </select>
            }
          </div>
          <div class="detail-row">
            <label>Data di creazione:</label>
            <p>{{ selectedUser.created_at | date: 'dd/MM/yyyy'}}</p>
          </div>
          <div class="detail-row">
            <label>Ultimo accesso:</label>
            <p>{{ selectedUser.last_login | date: 'dd/MM/yyyy'}}</p>
          </div>
        </div>
      </div>
      <footer class="popup-footer">
        @if(!isEditing){
        <button class="edit-button" (click)="toggleEdit($event, selectedUser)">Modifica</button>
        } @else {
        <button class="save-button" (click)="saveChanges()">Salva</button>
        }
        <button class="annulla-button" (click)="toggleDetails($event, selectedUser)">Chiudi</button>
      </footer>
    </div>
  </div>
  }
  @if(showOrders && selectedUser){
  <div class="popup-overlay" aria-modal="true" role="dialog">
    <div class="popup-content">
      <header class="popup-header">
        <h3>Ordini di {{ selectedUser.first_name + ' ' + selectedUser.last_name }}</h3>
      </header>
      <div class="popup-body">
      </div>
    </div>
  </div>
  }
</div>
