<section class="gestioni-utente full-width">
	<header class="gestioni-header">
		<h2>Gestioni utente</h2>
		<p class="muted">Gestisci gli account utente: crea, modifica o blocca gli utenti registrati.</p>

		<div class="gestion-actions">
			<button class="qa-btn primary" (click)="onNewUser()" aria-label="Nuovo utente">Nuovo utente</button>
		</div>
	</header>

	<div class="gestioni-body">
		<div class="search-row">
			<input type="search" placeholder="Cerca per nome o email..." [(ngModel)]="query" (ngModelChange)="applyFilter()" aria-label="Cerca utenti" />
		</div>

			<div class="users-list">
				<div *ngIf="loading" class="muted">Caricamento utenti...</div>
				<div *ngIf="error" class="error muted">{{ error }}</div>
				<div *ngIf="!loading && (!filteredUsers || filteredUsers.length === 0)" class="muted">Nessun utente trovato.</div>
				<table *ngIf="!loading && filteredUsers && filteredUsers.length">
				<thead>
					<tr><th>Nome</th><th>Email</th><th>Ruolo</th><th>Numero ordini</th><th>Azioni</th></tr>
				</thead>
				<tbody>
						<tr *ngFor="let u of filteredUsers">
							<td>{{ u.first_name }} {{ u.last_name }}</td>
							<td>{{ u.email }}</td>
							<td>{{ u.role }}</td>
							<td>{{ u.orders_count || 0 }}</td>
							<td>
								<button class="qa-btn secondary" (click)="onToggleRole(u)" [disabled]="updatingIds.has(u.user_id || u.id)">Modifica Ruolo</button>
								<button class="qa-btn danger"
									[ngClass]="{ 'suspended': u.account_status === 'suspended', 'active': u.account_status === 'active' }"
									(click)="onBlockUser(u)"
									[disabled]="updatingIds.has(u.user_id || u.id)">
									{{ (u.account_status === 'suspended') ? 'Attiva' : 'Sospendi' }}
								</button>
								<button class="qa-btn danger" (click)="onDeleteUser(u)" [disabled]="updatingIds.has(u.user_id || u.id)" style="margin-left: 8px;">Elimina</button>
							</td>
						</tr>
				</tbody>
			</table>
		</div>
	</div>
</section>

<div *ngIf="showCreate" class="modal-backdrop" aria-modal="true" role="dialog" (click)="onBackdropClick($event)">
	<div class="modal">
		<header class="modal-header">
			<h3>Nuovo utente</h3>
		</header>
		<div class="modal-body">
			<div class="form-row">
				<label>Nome</label>
				<input type="text" [(ngModel)]="newUser.first_name" placeholder="Mario" />
			</div>
			<div class="form-row">
				<label>Cognome</label>
				<input type="text" [(ngModel)]="newUser.last_name" placeholder="Rossi" />
			</div>
			<div class="form-row">
				<label>Email</label>
				<input type="email" [(ngModel)]="newUser.email" placeholder="mario.rossi@example.com" />
			</div>
			<div class="form-row">
				<label>Password</label>
				<input type="password" [(ngModel)]="newUser.password" placeholder="••••••••" />
			</div>
			<div class="form-row">
				<label>Data di nascita</label>
				<input type="date" [(ngModel)]="newUser.birth_date" />
			</div>
			<div class="form-row">
				<label>Telefono</label>
				<input type="tel" [(ngModel)]="newUser.phone_number" placeholder="3331234567" />
			</div>
			<div class="form-row">
				<label>Ruolo</label>
				<select [(ngModel)]="newUser.role">
					<option value="customer">customer</option>
					<option value="admin">admin</option>
				</select>
			</div>
			<div class="form-row">
				<label>Stato account</label>
				<select [(ngModel)]="newUser.account_status">
					<option value="active">active</option>
					<option value="suspended">suspended</option>
				</select>
			</div>
			<div class="error muted" *ngIf="error">{{ error }}</div>
		</div>
		<footer class="modal-footer">
			<button class="qa-btn secondary" (click)="cancelCreate()" [disabled]="creating">Annulla</button>
			<button class="qa-btn primary" (click)="submitCreate()" [disabled]="creating">Crea</button>
		</footer>
	</div>
</div>


