<!-- Action toolbar -->
<div class="actions-toolbar" role="region" aria-label="Azioni categorie e prodotti">
	<div class="actions-inner">
		<button class="action-btn primary" (click)="onCreateCategory()">Nuova categoria</button>
		<button class="action-btn danger" [disabled]="!selectedCategory" (click)="onDeleteCategory()">Elimina categoria</button>
		<button class="action-btn" (click)="onAddProduct()">Aggiungi prodotto</button>
	</div>
	<div class="actions-hint">Seleziona una categoria per abilitare alcune azioni.</div>
  
</div>

<div class="categories-container">
	<h3>Categorie</h3>

	<!-- Loading categories -->
	<div *ngIf="loadingCategories" class="loading">Caricamento categorie...</div>
	<!-- Error categories -->
	<div *ngIf="errorCategories" class="error">{{ errorCategories }}</div>

	<!-- Categories as buttons -->
	<div class="category-buttons" *ngIf="!loadingCategories && !errorCategories">
		<button
			class="category-btn"
			*ngFor="let c of categories"
			[class.active]="selectedCategory?.id === c.id"
			(click)="selectCategory(c)">
			{{ c.name }}
		</button>
	</div>

	<!-- Products box for selected category -->
		<div class="products-box" *ngIf="selectedCategory">
		<div class="products-box-header">
				<h4>Prodotti in "{{ selectedCategory.name }}"</h4>
			<button class="close-btn" (click)="selectCategory(selectedCategory!)">Chiudi</button>
		</div>

		<div *ngIf="loadingProducts" class="loading">Caricamento prodotti...</div>
		<div *ngIf="errorProducts" class="error">{{ errorProducts }}</div>
		<div *ngIf="!loadingProducts && !errorProducts">
			<div *ngIf="products.length === 0" class="empty">Nessun prodotto in questa categoria.</div>
			<ul class="product-list" *ngIf="products.length > 0">
				<li *ngFor="let p of products" class="product-item">
					<div class="pi-main">
						<div class="pi-name">{{ p.name }}</div>
						<div class="pi-price">{{ formatCurrency(p.price) }}</div>
					</div>
					<div class="pi-desc" *ngIf="p.description">{{ p.description }}</div>
							<div class="pi-actions">
								<button class="action-btn danger" (click)="removeProduct(p.id)">Rimuovi</button>
							</div>
				</li>
			</ul>
		</div>
	</div>

		<!-- New Category Modal -->
		<div class="modal-backdrop" *ngIf="showCreateModal">
			<div class="modal" role="dialog" aria-modal="true" aria-label="Nuova categoria">
				<div class="modal-header">
					<h4>Nuova categoria</h4>
					<button class="close-btn" (click)="closeCreateModal()">Chiudi</button>
				</div>

				<div class="modal-body">
					<div *ngIf="loadingCreate" class="loading">Caricamento struttura campi...</div>
					<div *ngIf="createError" class="error">{{ createError }}</div>

					<form *ngIf="!loadingCreate && !createError" (ngSubmit)="submitCreateCategory()">
						<div class="form-grid">
							<div class="form-field" *ngFor="let col of categoryColumns">
								<label [for]="col.column_name">{{ col.column_name }}</label>

								<input *ngIf="inputTypeFor(col) !== 'checkbox'"
											 class="input"
											 [type]="inputTypeFor(col)"
											 [id]="col.column_name"
											 [(ngModel)]="categoryForm[col.column_name]"
											 [name]="col.column_name"
											 [required]="col.is_nullable === 'NO'"/>

								<label class="checkbox" *ngIf="inputTypeFor(col) === 'checkbox'">
									<input type="checkbox"
												 [(ngModel)]="categoryForm[col.column_name]"
												 [name]="col.column_name"/>
									<span>True/False</span>
								</label>
							</div>
						</div>

						<div class="modal-actions">
							<button type="submit" class="action-btn primary">Salva</button>
							<button type="button" class="action-btn" (click)="closeCreateModal()">Annulla</button>
						</div>
					</form>
				</div>
			</div>
		</div>
</div>

<!-- Add Product Modal -->
<div class="modal-backdrop" *ngIf="showAddProductModal">
	<div class="modal" role="dialog" aria-modal="true" aria-label="Aggiungi prodotto">
		<div class="modal-header">
			<h4>Aggiungi prodotto</h4>
			<button class="close-btn" (click)="closeAddProductModal()">Chiudi</button>
		</div>

		<div class="modal-body">
			<div *ngIf="loadingAddProduct" class="loading">Caricamento struttura campi...</div>
			<div *ngIf="addProductError" class="error">{{ addProductError }}</div>

			<form *ngIf="!loadingAddProduct && !addProductError" (ngSubmit)="submitAddProduct()">
				<div class="form-grid">
					<div class="form-field" *ngFor="let col of productColumns">
						<label [for]="col.column_name">{{ col.column_name }}</label>

						<input *ngIf="inputTypeFor(col) !== 'checkbox'"
									 class="input"
									 [type]="inputTypeFor(col)"
									 [id]="col.column_name"
									 [(ngModel)]="productForm[col.column_name]"
									 [name]="col.column_name"
									 [required]="col.is_nullable === 'NO'"/>

						<label class="checkbox" *ngIf="inputTypeFor(col) === 'checkbox'">
							<input type="checkbox"
										 [(ngModel)]="productForm[col.column_name]"
										 [name]="col.column_name"/>
							<span>True/False</span>
						</label>
					</div>
				</div>

				<div class="modal-actions">
					<button type="submit" class="action-btn primary">Salva</button>
					<button type="button" class="action-btn" (click)="closeAddProductModal()">Annulla</button>
				</div>
			</form>
		</div>
	</div>
</div>
